name: CI Pipeline

# --------------------------------------------------
# Triggers
# --------------------------------------------------
# Run pipeline on:
# - push to main
# - pull requests targeting main
# --------------------------------------------------
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build, Test & Docker Compose (DEV)
    runs-on: ubuntu-latest

    # --------------------------------------------------
    # Global environment variables for this job
    #
    # IMPORTANT:
    # - We are in DEVELOPMENT stage
    # - Configuration is provided via GitHub Actions secrets
    # - NO .env file is used or required
    # --------------------------------------------------
    env:
      # -------------------------
      # Spring profile
      # -------------------------
      SPRING_PROFILES_ACTIVE: test

      # -------------------------
      # Database configuration (from GitHub Secrets)
      # -------------------------
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

      # -------------------------
      # JWT configuration
      # -------------------------
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      JWT_EXPIRATION: 15

    steps:
      # --------------------------------------------------
      # Checkout repository
      # --------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # --------------------------------------------------
      # Set up Java 21
      # Required for Maven build and tests
      # --------------------------------------------------
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      # --------------------------------------------------
      # Run unit tests
      #
      # Notes:
      # - Pure unit tests (no DB, no Docker, no Spring context)
      # - Same command is used locally and in CI
      # - Pipeline MUST fail here if tests are red
      # --------------------------------------------------
      - name: Run auth unit tests
        working-directory: auth
        run: mvn test

      - name: Publish JaCoCo coverage summary
        working-directory: auth
        continue-on-error: true
        run: |
          if [ -f target/site/jacoco/index.html ]; then
            echo "## Auth module â€“ test coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            grep -A 1 "<tfoot>" target/site/jacoco/index.html \
              | sed -n 's/.*<td class="ctr2">\([0-9]*%\)<\/td>.*/Coverage: \1/p' \
              >> $GITHUB_STEP_SUMMARY
          else
            echo "JaCoCo report not found" >> $GITHUB_STEP_SUMMARY
          fi



      - name: Build backend (no tests yet)
        working-directory: backend
        run: mvn -DskipTests package


      # --------------------------------------------------
      # Cache npm dependencies (frontend)
      # --------------------------------------------------
      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      # --------------------------------------------------
      # Set up Docker Buildx
      # Required for docker compose build
      # --------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --------------------------------------------------
      # Build and start Docker containers
      #
      # Notes:
      # - Uses DEV profile
      # - Uses GitHub Secrets as environment variables
      # - Happens ONLY after unit tests pass
      # --------------------------------------------------
      - name: Build and start containers
        run: docker compose up -d --build

      # --------------------------------------------------
      # Wait for services to start
      # (simple and sufficient for development CI)
      # --------------------------------------------------
      - name: Wait for services to start
        run: sleep 20

      # --------------------------------------------------
      # Show logs of auth service
      # Useful for debugging CI failures
      # --------------------------------------------------
      - name: Show auth service logs
        run: docker compose logs auth

      # --------------------------------------------------
      # (Optional) Show logs of all services
      # --------------------------------------------------
      - name: Show all services logs
        run: docker compose logs
