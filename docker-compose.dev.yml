# for dynamic frontend binding: 
# docker compose  -f docker-compose.dev.yml up -d --build
# enter localhost:3000 to access frontend
# and then after frontend change: 
# docker compose -f docker-compose.dev.yml restart frontend
services:
  # =========================
  # PostgreSQL Database
  # =========================
  postgres:

    image: postgres:14.11
    container_name: campus-postgres
    restart: unless-stopped

    environment:
      POSTGRES_DB: campus
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}

    ports:
      - "5432:5432"
      # Expose PostgreSQL to host for development and data import

    volumes:
      - postgres-data:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user -d campus"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    networks:
      - campus-net



  # =========================
  # Auth Service (Spring Boot)
  # =========================
  auth:
    build: ./auth
    # Build image from auth/Dockerfile

    container_name: campus-auth

    environment:
      SPRING_PROFILES_ACTIVE: prod
      # Activate production Spring profile

      DB_HOST: postgres
      # Hostname of the database
      # Uses Docker service name for internal DNS resolution

      DB_PORT: 5432
      # PostgreSQL default port

      DB_NAME: campus
      # Database name

      DB_USERNAME: ${DB_USERNAME}
      # Database username
      DB_PASSWORD: ${DB_PASSWORD}
      # Database password injected from environment

      JWT_SECRET: ${JWT_SECRET}
      # Secret key for signing JWT tokens
      # MUST be provided via environment variable / CI secrets

      JWT_EXPIRATION_MINUTES: 15
      # JWT token lifetime (short TTL for production security)

    depends_on:
      postgres:
        condition: service_healthy
      # Ensures database container is started before auth service
      # (does NOT wait for DB to be fully ready)

    expose:
      - "8080"
      # Exposes port only inside Docker network
      # Not accessible from outside directly

    networks:
      - campus-net


  # =========================
  # Backend Service
  # =========================
  backend:
    build: ./backend
    container_name: campus-backend

    environment:
      SPRING_PROFILES_ACTIVE: dev

      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: campus

      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}

    depends_on:
      postgres:
        condition: service_healthy

    expose:
      - "8080"

    networks:
      - campus-net


  # =========================
  # Frontend Service
  # =========================
  frontend:
    build: 
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: campus-frontend
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "3000:80"

    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 80"

    networks:
      - campus-net
    restart: unless-stopped


  # =========================
  # Nginx Reverse Proxy
  # =========================
  nginx:
    build: ./nginx
    container_name: campus-nginx

    ports:
      - "80:80"
      # Exposes HTTP port to host
      # Single entry point to the system

    depends_on:
      - frontend
      - auth
      - backend
      # Ensure all application services are started before Nginx

    networks:
      - campus-net


# =========================
# Docker Network
# =========================
networks:
  campus-net:
    driver: bridge
    # Isolated internal network
    # Services can communicate by service name
    # Not directly accessible from outside


# =========================
# Persistent Volumes
# =========================
volumes:
  postgres-data:
  # Named volume for PostgreSQL data
  # Managed by Docker
