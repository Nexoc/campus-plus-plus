# =========================
# NGINX base configuration
# =========================

# The events block is mandatory, even if empty
events {}

http {

  # ==================================================
  # Upstreams
  #
  # Logical names for backend services.
  # NGINX resolves them via Docker service names.
  # ==================================================

  upstream auth_service {
    # Authentication service (Spring Boot / FastAPI)
    # "auth" must match the service name in docker-compose
    server auth:8080;
  }

  upstream backend_service {
    # Main application backend
    server backend:8080;
  }

  # ==================================================
  # Main server block
  #
  # Acts as API Gateway and single entry point
  # ==================================================

  server {
    listen 80;

    # --------------------------------------------------
    # FRONTEND (Vue SPA)
    #
    # Serves static files generated by Vue (dist/)
    # try_files is required for client-side routing
    # --------------------------------------------------
    location / {
      root /usr/share/nginx/html;   # Vue build output
      index index.html;
      try_files $uri /index.html;   # SPA fallback for Vue Router
    }

    # --------------------------------------------------
    # AUTH SERVICE (PUBLIC ENDPOINTS)
    #
    # Examples:
    #   /auth/login
    #   /auth/register
    #
    # These endpoints are accessible without authentication
    # --------------------------------------------------
    location /auth/ {
      proxy_pass http://auth_service;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
    }

    # --------------------------------------------------
    # INTERNAL AUTH CHECK ENDPOINT
    #
    # Used ONLY by nginx (not accessible from browser)
    #
    # Validates JWT and returns:
    #   - 200 + headers → authorized
    #   - 401 / 403     → unauthorized
    # --------------------------------------------------
    location = /_auth_check {
      internal;

      # Call auth service validation endpoint
      proxy_pass http://auth_service/auth/validate;

      # Do not forward request body (security + performance)
      proxy_pass_request_body off;
      proxy_set_header Content-Length "";

      # Forward Authorization header (JWT)
      proxy_set_header Authorization $http_authorization;
    }

    # --------------------------------------------------
    # PROTECTED BACKEND API
    #
    # All endpoints under:
    #   /api/**
    #
    # Request flow:
    # 1. NGINX calls auth_service for validation
    # 2. If auth fails → request is blocked
    # 3. If auth succeeds → request is forwarded to backend
    # --------------------------------------------------
    location /api/ {

      # Perform authorization BEFORE proxying
      auth_request /_auth_check;

      # Extract user data from auth-service response headers
      auth_request_set $user_id    $upstream_http_x_user_id;
      auth_request_set $user_roles $upstream_http_x_user_roles;

      # Forward user information to backend
      proxy_set_header X-User-Id    $user_id;
      proxy_set_header X-User-Roles $user_roles;

      # Proxy request to main backend service
      proxy_pass http://backend_service;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
    }
  }
}
