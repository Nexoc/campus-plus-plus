# ==================================================
# NGINX GATEWAY CONFIGURATION
# Project: Campus++
#
# Responsibilities:
# - Public entry point for the entire system
# - Serve frontend SPA
# - Enforce authentication & authorization
# - Protect backend services
#
# Security model:
# - JWT validation delegated to Auth Service
# - NGINX enforces access via auth_request
# - Backend NEVER exposed publicly
# ==================================================

events {}

http {

  # ==================================================
  # RATE LIMITING ZONES
  # --------------------------------------------------
  # Protect authentication endpoints from brute-force
  # attacks before they reach the backend.
  # ==================================================

  # Limit login attempts per IP:
  # - 5 requests per minute
  # - burst allows short spikes
  limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;


  # ==================================================
  # UPSTREAM DEFINITIONS (Docker services)
  # ==================================================

  upstream frontend_service {
    server frontend:80;
  }

  upstream auth_service {
    server auth:8080;
  }

  upstream backend_service {
    server backend:8080;
  }


  # ==================================================
  # MAIN SERVER
  # ==================================================
  server {
    listen 80;

    # ==================================================
    # GLOBAL SECURITY HEADERS
    # --------------------------------------------------
    # Applied to ALL responses.
    # Protects against:
    # - XSS
    # - Clickjacking
    # - MIME sniffing
    # - Unwanted browser APIs
    # ==================================================

    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # ==================================================
    # CONTENT SECURITY POLICY (CSP)
    # --------------------------------------------------
    # Prevents XSS by restricting where resources
    # can be loaded from.
    #
    # This policy is compatible with Vue SPA.
    # ==================================================
    add_header Content-Security-Policy "
      default-src 'self';
      script-src 'self';
      style-src 'self' 'unsafe-inline';
      img-src 'self' data:;
      font-src 'self';
      connect-src 'self';
      frame-ancestors 'none';
    " always;


    # ==================================================
    # SECURITY: BLOCK DIRECT ACCESS TO /auth/validate
    # --------------------------------------------------
    # /auth/validate is INTERNAL ONLY.
    #
    # Purpose:
    # - Validate JWT tokens
    # - Resolve user identity and roles
    #
    # MUST NOT be reachable by external clients.
    # ==================================================
    location = /auth/validate {
      return 404;
    }


    # ==================================================
    # FRONTEND (PUBLIC)
    # --------------------------------------------------
    # Vue.js Single Page Application
    # - Public
    # - No authentication required
    # ==================================================
    location / {
      proxy_pass http://frontend_service;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }


    # ==================================================
    # AUTH LOGIN (PUBLIC, RATE-LIMITED)
    # --------------------------------------------------
    # Protects against brute-force attacks.
    # Backend is only reached for allowed attempts.
    # ==================================================
    location = /auth/login {

      # Apply rate limiting
      limit_req zone=login_limit burst=3 nodelay;

      proxy_pass http://auth_service;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass_request_headers on;
    }


    # ==================================================
    # AUTH SERVICE (PUBLIC ENDPOINTS)
    # --------------------------------------------------
    # Exposed endpoints:
    # - POST /auth/login
    # - POST /auth/register
    # - POST /auth/csrf
    #
    # NOTE:
    # /auth/validate is NOT accessible here
    # ==================================================
    location /auth/ {
      proxy_pass http://auth_service;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass_request_headers on;
      proxy_cookie_path / /;
    }


    # ==================================================
    # ACCOUNT ENDPOINTS (PROTECTED)
    # --------------------------------------------------
    # User-specific operations (e.g. change password).
    # Requires valid JWT.
    # ==================================================
    location /account/ {
      auth_request /_auth_check;

      # Extract identity from Auth Service
      auth_request_set $user_id    $upstream_http_x_user_id;
      auth_request_set $user_roles $upstream_http_x_user_roles;

      # Forward identity to Auth Service
      proxy_set_header X-User-Id    $user_id;
      proxy_set_header X-User-Roles $user_roles;

      proxy_pass http://auth_service;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }


    # ==================================================
    # ADMIN ENDPOINTS (PROTECTED, ROLE-BASED)
    # --------------------------------------------------
    # Administrative operations:
    # - User management
    # - Role changes
    # - Enable/disable accounts
    # ==================================================
    location /admin/ {
      auth_request /_auth_check;

      auth_request_set $user_id    $upstream_http_x_user_id;
      auth_request_set $user_roles $upstream_http_x_user_roles;

      proxy_set_header X-User-Id    $user_id;
      proxy_set_header X-User-Roles $user_roles;

      proxy_pass http://auth_service;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_cookie_path / /;
    }


    # ==================================================
    # ACTUATOR (MONITORING)
    # --------------------------------------------------
    # Used for health checks.
    # Should be restricted further in production.
    # ==================================================
    location /actuator/ {
      proxy_pass http://auth_service/actuator/;
      proxy_set_header Host $host;
    }


    # ==================================================
    # INTERNAL AUTH CHECK
    # --------------------------------------------------
    # Used ONLY by NGINX via auth_request.
    #
    # Flow:
    # - NGINX calls /_auth_check
    # - Proxies to /auth/validate
    # - Auth Service validates JWT
    # - Returns X-User-* headers
    #
    # SECURITY:
    # - "internal" prevents external access
    # ==================================================
    location = /_auth_check {
      internal;

      proxy_pass http://auth_service/auth/validate;

      # IMPORTANT:
      # Docker service names may contain underscores,
      # but HTTP Host header MUST be RFC-compliant.
      # Tomcat rejects hosts with "_".
      proxy_set_header Host localhost;

      proxy_set_header Authorization $http_authorization;
      proxy_set_header Content-Length "";
      proxy_set_header X-Original-URI $request_uri;
    }



    # ==================================================
    # SWAGGER / API DOCUMENTATION
    # --------------------------------------------------
    # Enabled for development.
    # Can be disabled or protected in production.
    # ==================================================
    location /swagger-ui/ {
      proxy_pass http://auth_service/swagger-ui/;
      proxy_set_header Host $host;
    }

    location /v3/api-docs {
      proxy_pass http://auth_service/v3/api-docs;
      proxy_set_header Host $host;
    }


    # ==================================================
    # BACKEND API (PROTECTED)
    # --------------------------------------------------
    # Main application API.
    #
    # Security:
    # - auth_request enforces authentication
    # - Backend trusts NGINX-provided identity headers
    # ==================================================
    # exceptions for specific paths
    location /api/courses {
        # Don't require auth_request for courses
        proxy_pass http://backend:8080;
    }

    location /api/ {
      auth_request /_auth_check;

      auth_request_set $user_id    $upstream_http_x_user_id;
      auth_request_set $user_roles $upstream_http_x_user_roles;

      proxy_set_header X-User-Id    $user_id;
      proxy_set_header X-User-Roles $user_roles;

      proxy_pass http://backend_service;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }
  }
}
